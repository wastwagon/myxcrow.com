# MYXCROW Deployment Guide

Complete guide for deploying MYXCROW to Render using Blueprint deployment.

## üìã Prerequisites

- GitHub repository with all code committed
- Render account (sign up at https://render.com)
- Paystack API keys (for payment processing)
- S3-compatible storage credentials (AWS S3, DigitalOcean Spaces, etc.)
- SMTP email credentials (SendGrid, Mailgun, etc.)

## üöÄ Deployment Steps

### Step 1: Push to GitHub

```bash
# Push your committed changes
git push origin main
```

### Step 2: Connect Repository to Render

1. Log in to [Render Dashboard](https://dashboard.render.com)
2. Click **"New +"** ‚Üí **"Blueprint"**
3. Connect your GitHub repository
4. Select the repository: `myxcrow` (or your repo name)
5. Render will automatically detect `render.yaml`

### Step 3: Configure Environment Variables

Render will create services based on `render.yaml`. You need to set these environment variables manually:

#### For `myxcrow-api` service:

**Required:**
- `S3_ENDPOINT` - Your S3 endpoint (e.g., `https://s3.amazonaws.com`)
- `S3_ACCESS_KEY` - Your S3 access key
- `S3_SECRET_KEY` - Your S3 secret key
- `PAYSTACK_SECRET_KEY` - Your Paystack secret key
- `PAYSTACK_PUBLIC_KEY` - Your Paystack public key
- `EMAIL_HOST` - SMTP host (e.g., `smtp.sendgrid.net`)
- `EMAIL_PORT` - SMTP port (usually `587`)
- `EMAIL_USER` - SMTP username
- `EMAIL_PASSWORD` - SMTP password
- `EMAIL_FROM` - From email address (e.g., `noreply@myxcrow.com`)

**Auto-configured:**
- `DATABASE_URL` - Auto-set from PostgreSQL database
- `REDIS_URL` - Auto-set from Redis service
- `JWT_SECRET` - Auto-generated by Render
- `WEB_APP_URL` - Auto-set from web service URL

#### For `myxcrow-web` service:

**Auto-configured:**
- `NEXT_PUBLIC_API_BASE_URL` - Will be auto-set, but verify it matches your API URL
- `NODE_ENV` - Set to `production`
- `PORT` - Set to `3000`

**Note:** After deployment, update `NEXT_PUBLIC_API_BASE_URL` in the web service to match your actual API URL:
- Go to `myxcrow-web` service ‚Üí Environment
- Set `NEXT_PUBLIC_API_BASE_URL` to: `https://myxcrow-api.onrender.com/api`
  (Replace `myxcrow-api` with your actual API service name)

### Step 4: Deploy

1. Click **"Apply"** in Render dashboard
2. Render will:
   - Create PostgreSQL database
   - Create Redis instance
   - Build and deploy API service
   - Build and deploy Web service
   - Run database migrations automatically

### Step 5: Verify Deployment

1. **Check API Health:**
   ```
   https://myxcrow-api.onrender.com/api/health
   ```
   Should return: `{"status":"ok"}`

2. **Check Web Frontend:**
   ```
   https://myxcrow-web.onrender.com
   ```
   Should load the application

3. **Run Database Migrations** (if needed):
   - Go to `myxcrow-api` service ‚Üí Shell
   - Run: `cd services/api && pnpm prisma migrate deploy`

4. **Seed Database** (optional):
   - Go to `myxcrow-api` service ‚Üí Shell
   - Run: `cd services/api && pnpm seed`

## üîß Post-Deployment Configuration

### 1. Update API Base URL

After deployment, ensure the web service has the correct API URL:

1. Go to `myxcrow-web` service in Render dashboard
2. Navigate to **Environment** tab
3. Verify `NEXT_PUBLIC_API_BASE_URL` is set to your API service URL
4. If not, add it: `https://myxcrow-api.onrender.com/api`

### 2. Configure S3 Bucket

1. Create an S3 bucket (or use existing)
2. Set bucket name in `S3_BUCKET` environment variable: `escrow-evidence`
3. Configure bucket permissions for your access key
4. Ensure CORS is configured if needed

### 3. Set Up Email Service

Configure your SMTP provider:
- **SendGrid**: Use API key as password
- **Mailgun**: Use SMTP credentials
- **AWS SES**: Use SMTP credentials

### 4. Configure Paystack

1. Get your Paystack API keys from dashboard
2. Set `PAYSTACK_SECRET_KEY` and `PAYSTACK_PUBLIC_KEY`
3. Configure webhook URL: `https://myxcrow-api.onrender.com/api/payments/webhook`

## üìä Monitoring

### Health Checks

- **API Health:** `https://myxcrow-api.onrender.com/api/health`
- **Web:** `https://myxcrow-web.onrender.com`

### Logs

View logs in Render dashboard:
- Go to service ‚Üí **Logs** tab
- Monitor for errors and warnings

## üîê Security Checklist

- [ ] `JWT_SECRET` is auto-generated (strong random value)
- [ ] Database credentials are secure (managed by Render)
- [ ] S3 credentials are stored securely in environment variables
- [ ] Paystack keys are stored securely
- [ ] Email credentials are stored securely
- [ ] CORS is configured correctly
- [ ] HTTPS is enabled (automatic on Render)

## üêõ Troubleshooting

### Build Failures

1. Check build logs in Render dashboard
2. Verify `package.json` dependencies are correct
3. Ensure `pnpm-lock.yaml` is committed

### Database Connection Issues

1. Verify `DATABASE_URL` is set correctly
2. Check database is running in Render dashboard
3. Verify migrations ran successfully

### API Not Responding

1. Check API service logs
2. Verify health endpoint: `/api/health`
3. Check environment variables are set correctly

### Frontend Not Loading

1. Check web service logs
2. Verify `NEXT_PUBLIC_API_BASE_URL` is correct
3. Check build completed successfully

## üìù Environment Variables Reference

### API Service (`myxcrow-api`)

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `DATABASE_URL` | ‚úÖ | PostgreSQL connection | Auto-set |
| `REDIS_URL` | ‚úÖ | Redis connection | Auto-set |
| `JWT_SECRET` | ‚úÖ | JWT signing secret | Auto-generated |
| `WEB_APP_URL` | ‚úÖ | Frontend URL | Auto-set |
| `S3_ENDPOINT` | ‚úÖ | S3 endpoint URL | `https://s3.amazonaws.com` |
| `S3_ACCESS_KEY` | ‚úÖ | S3 access key | Your key |
| `S3_SECRET_KEY` | ‚úÖ | S3 secret key | Your secret |
| `S3_BUCKET` | ‚úÖ | S3 bucket name | `escrow-evidence` |
| `S3_REGION` | ‚úÖ | S3 region | `us-east-1` |
| `PAYSTACK_SECRET_KEY` | ‚úÖ | Paystack secret | `sk_live_xxx` |
| `PAYSTACK_PUBLIC_KEY` | ‚úÖ | Paystack public | `pk_live_xxx` |
| `EMAIL_HOST` | ‚úÖ | SMTP host | `smtp.sendgrid.net` |
| `EMAIL_PORT` | ‚úÖ | SMTP port | `587` |
| `EMAIL_USER` | ‚úÖ | SMTP username | Your username |
| `EMAIL_PASSWORD` | ‚úÖ | SMTP password | Your password |
| `EMAIL_FROM` | ‚úÖ | From email | `noreply@myxcrow.com` |

### Web Service (`myxcrow-web`)

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `NEXT_PUBLIC_API_BASE_URL` | ‚úÖ | API base URL | `https://myxcrow-api.onrender.com/api` |
| `NODE_ENV` | ‚úÖ | Environment | `production` |
| `PORT` | ‚úÖ | Port number | `3000` |

## üéØ Quick Deployment Checklist

- [ ] Code pushed to GitHub
- [ ] Repository connected to Render
- [ ] Blueprint detected (`render.yaml`)
- [ ] Environment variables configured
- [ ] Services deployed successfully
- [ ] Database migrations ran
- [ ] API health check passes
- [ ] Web frontend loads
- [ ] API base URL configured correctly
- [ ] S3 bucket configured
- [ ] Email service configured
- [ ] Paystack webhook configured

## üìö Additional Resources

- [Render Documentation](https://render.com/docs)
- [Render Blueprint Spec](https://render.com/docs/blueprint-spec)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [NestJS Deployment](https://docs.nestjs.com/recipes/deployment)

---

**Ready to deploy?** Push to GitHub and connect to Render!

